<div
  class="modal fade"
  id="creditosModal"
  tabindex="-1"
  aria-labelledby="creditosModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="creditosModalLabel">
          {{
            modoCreacionCredito
              ? creditoSeleccionado
                ? "Editar Credito"
                : "Registrar Nuevo credito"
              : "Detalle creditos"
          }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Botón para iniciar el registro -->
        <div
          class="d-flex justify-content-end mb-3"
          *ngIf="!modoCreacionCredito"
        >
          <button class="btn btn-primary" (click)="mostrarFormularioCredito()">
            Registrar Nuevo Crédito
          </button>
        </div>

        <!-- Formulario de Registro de Crédito -->
        <div *ngIf="modoCreacionCredito">
          <h5>Registrar Nuevo Crédito</h5>
          <form [formGroup]="formularioCredito" (ngSubmit)="guardarCredito()">
            <!-- Campos Principales del Crédito -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cliente</label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Buscar cliente"
                  matInput
                  [formControl]="clienteCtrl"
                  [matAutocomplete]="autoCliente"
                />
                <mat-autocomplete
                  #autoCliente="matAutocomplete"
                  [displayWith]="mostrarCliente"
                  (optionSelected)="
                    formularioCredito.patchValue({
                      clienteId: $event.option.value.id
                    })
                  "
                >
                  <mat-option
                    *ngFor="let c of clientesFiltrados$ | async"
                    [value]="c"
                  >
                    {{ c.nombre }}
                  </mat-option>
                </mat-autocomplete>
              </div>

              <div class="col-md-6">
                <label for="placa" class="form-label">Placa (Opcional)</label>
                <input
                  type="text"
                  id="placa"
                  class="form-control"
                  formControlName="placa"
                />
              </div>
            </div>

            <!-- Items del Crédito -->
            <h6>Productos</h6>
            <div formArrayName="items">
              <div
                *ngFor="let item of items.controls; let i = index"
                [formGroupName]="i"
                class="row align-items-center mb-2"
              >
                <div class="col-md-5">
                  <label class="form-label">Producto</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Buscar producto"
                    matInput
                    formControlName="productoCtrl"
                    [matAutocomplete]="autoProducto"
                  />
                  <mat-autocomplete
                    #autoProducto="matAutocomplete"
                    [displayWith]="mostrarProducto"
                    (optionSelected)="
                      items
                        .at(i)
                        .patchValue({ productoId: $event.option.value.id })
                    "
                  >
                    <mat-option
                      *ngFor="let p of productosFiltrados$[i] | async"
                      [value]="p"
                    >
                      {{ p.nombre }}
                    </mat-option>
                  </mat-autocomplete>
                </div>

                <div class="col-md-5">
                  <label class="form-label">Precio de Venta</label>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="precioVenta"
                  />
                </div>
                <div class="col-md-1 d-flex mt-3 pt-3 align-items-end">
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    (click)="eliminarItem(i)"
                    title="Eliminar"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <button
              type="button"
              class="btn btn-outline-primary btn-sm mb-3"
              (click)="agregarItem()"
            >
              + Agregar Producto
            </button>

            <!-- Botones de Acción del Formulario -->
            <div class="d-flex justify-content-end">
              <button
                type="button"
                class="btn btn-secondary me-2"
                (click)="ocultarFormularioCredito()"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-success"
                [disabled]="formularioCredito.invalid"
              >
                Guardar Crédito
              </button>
            </div>
          </form>
          <hr />
        </div>

        <!-- Tabla de Créditos Existentes -->
        <div *ngIf="!modoCreacionCredito">
          <h5>Créditos Registrados</h5>
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
              <thead class="table-dark">
                <tr>
                  <th scope="col">Cliente</th>
                  <th scope="col">Fecha</th>
                  <th scope="col">Total</th>
                  <th scope="col">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let credito of creditos">
                  <td>{{ credito.cliente }}</td>
                  <td>{{ credito.fecha | date : "short" }}</td>
                  <td>
                    {{ credito.total | currency : "USD" : "symbol" : "1.0-0" }}
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-warning btn-sm me-2"
                      (click)="mostrarFormularioParaEditar(credito)"
                    >
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      (click)="anularCredito(credito)"
                      title="Anular"
                    >
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="creditos.length === 0">
                  <td colspan="4" class="text-center">
                    No hay créditos en este turno.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
